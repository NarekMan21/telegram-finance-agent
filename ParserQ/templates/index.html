<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Финансовый парсер Telegram</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .table-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 20px;
            height: 100%;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        .summary {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        .balance-summary {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .positive {
            color: #28a745;
            font-weight: bold;
        }
        .negative {
            color: #dc3545;
            font-weight: bold;
        }
        .balance-amount {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .table th, .table td {
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.2em 0.5em;
            font-size: 0.9rem;
        }
        .dataTables_wrapper .dataTables_info {
            font-size: 0.9rem;
        }
        .dataTables_wrapper .dataTables_length select {
            width: auto;
            font-size: 0.9rem;
        }
        .dataTables_wrapper .dataTables_filter input {
            font-size: 0.9rem;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        .main-row {
            margin-bottom: 20px;
        }
        /* Custom scrollbar for tables - 3 times taller */
        .dataTables_scrollBody {
            max-height: 1200px !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="text-center">Финансовый парсер Telegram</h1>
        
        <!-- Balance Summary -->
        <div class="balance-summary">
            <span>Всего средств осталось: </span>
            <span id="totalBalance" class="balance-amount">0</span>
        </div>
        
        <!-- Tables side by side -->
        <div class="row main-row">
            <!-- Income Table -->
            <div class="col-md-6">
                <div class="table-container">
                    <div class="header">
                        <h2 class="mb-0">ПРИХОД</h2>
                    </div>
                    <div class="summary">
                        <span>Общая сумма: </span>
                        <span id="incomeTotal" class="positive">0</span>
                    </div>
                    <table id="incomeTable" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Группа</th>
                                <th>Описание</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Expense Table -->
            <div class="col-md-6">
                <div class="table-container">
                    <div class="header">
                        <h2 class="mb-0">РАСХОД</h2>
                    </div>
                    <div class="summary">
                        <span>Общая сумма: </span>
                        <span id="expenseTotal" class="negative">0</span>
                    </div>
                    <table id="expenseTable" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Группа</th>
                                <th>Описание</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Function to format date
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU');
            }
            
            // Function to calculate total for income (as integer)
            function calculateIncomeTotal(data) {
                let total = 0;
                if (data && Array.isArray(data)) {
                    data.forEach(item => {
                        total += Math.round(parseFloat(item.amount)) || 0;
                    });
                }
                return total;
            }
            
            // Function to calculate total for expenses (as integer)
            function calculateExpenseTotal(data) {
                let total = 0;
                if (data && Array.isArray(data)) {
                    data.forEach(item => {
                        total += Math.round(parseFloat(item.amount)) || 0;
                    });
                }
                return total;
            }
            
            // Function to calculate and display total balance (as integer)
            function updateTotalBalance(incomeTotal, expenseTotal) {
                const balance = incomeTotal - expenseTotal;
                const balanceElement = $('#totalBalance');
                balanceElement.text(balance);
                
                // Apply color based on balance
                balanceElement.removeClass('positive negative');
                if (balance > 0) {
                    balanceElement.addClass('positive');
                } else if (balance < 0) {
                    balanceElement.addClass('negative');
                }
            }
            
            // Function to load income data
            function loadIncomeData() {
                return $.ajax({
                    url: '/api/transactions/income',
                    method: 'GET'
                });
            }
            
            // Function to load expense data
            function loadExpenseData() {
                return $.ajax({
                    url: '/api/transactions/expense',
                    method: 'GET'
                });
            }
            
            // Function to update income table
            function updateIncomeTable(data) {
                // Calculate and display total as integer
                const total = calculateIncomeTotal(data);
                $('#incomeTotal').text(total);
                
                // Reverse the data array to show newest first
                const reversedData = data.slice().reverse();
                
                // Check if table is already initialized
                if ($.fn.dataTable.isDataTable('#incomeTable')) {
                    $('#incomeTable').DataTable().clear().rows.add(reversedData).draw();
                } else {
                    const table = $('#incomeTable').DataTable({
                        data: reversedData,
                        columns: [
                            { 
                                data: 'timestamp',
                                render: function(data) {
                                    return formatDate(data);
                                }
                            },
                            { data: 'group_title' },
                            { 
                                data: 'description',
                                render: function(data) {
                                    return data.length > 50 ? data.substring(0, 50) + '...' : data;
                                }
                            },
                            { 
                                data: 'amount',
                                render: function(data) {
                                    // Display as integer without decimal places
                                    return '<span class="positive">' + Math.round(parseFloat(data)) + '</span>';
                                }
                            }
                        ],
                        order: [], // No initial sorting
                        ordering: false, // Disable sorting functionality
                        pageLength: -1, // Show all entries
                        paging: false,  // Disable pagination
                        scrollY: '1200px', // Make 3 times taller
                        scrollCollapse: true,
                        language: {
                            "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/ru.json"
                        }
                    });
                }
                
                return total;
            }
            
            // Function to update expense table
            function updateExpenseTable(data) {
                // Calculate and display total as integer
                const total = calculateExpenseTotal(data);
                $('#expenseTotal').text(total);
                
                // Reverse the data array to show newest first
                const reversedData = data.slice().reverse();
                
                // Check if table is already initialized
                if ($.fn.dataTable.isDataTable('#expenseTable')) {
                    $('#expenseTable').DataTable().clear().rows.add(reversedData).draw();
                } else {
                    const table = $('#expenseTable').DataTable({
                        data: reversedData,
                        columns: [
                            { 
                                data: 'timestamp',
                                render: function(data) {
                                    return formatDate(data);
                                }
                            },
                            { data: 'group_title' },
                            { 
                                data: 'description',
                                render: function(data) {
                                    return data.length > 50 ? data.substring(0, 50) + '...' : data;
                                }
                            },
                            { 
                                data: 'amount',
                                render: function(data) {
                                    // Display as integer without decimal places
                                    return '<span class="negative">' + Math.round(parseFloat(data)) + '</span>';
                                }
                            }
                        ],
                        order: [], // No initial sorting
                        ordering: false, // Disable sorting functionality
                        pageLength: -1, // Show all entries
                        paging: false,  // Disable pagination
                        scrollY: '1200px', // Make 3 times taller
                        scrollCollapse: true,
                        language: {
                            "url": "//cdn.datatables.net/plug-ins/1.11.5/i18n/ru.json"
                        }
                    });
                }
                
                return total;
            }
            
            // Function to update all data
            function updateAllData() {
                $.when(loadIncomeData(), loadExpenseData()).done(function(incomeResponse, expenseResponse) {
                    // Handle the response format (jQuery AJAX returns [data, textStatus, jqXHR])
                    const incomeData = incomeResponse[0] || [];
                    const expenseData = expenseResponse[0] || [];
                    
                    // Update tables and get totals
                    const incomeTotal = updateIncomeTable(incomeData);
                    const expenseTotal = updateExpenseTable(expenseData);
                    
                    // Update balance
                    updateTotalBalance(incomeTotal, expenseTotal);
                }).fail(function() {
                    // Handle errors
                    updateTotalBalance(0, 0);
                    $('#incomeTotal').text('0');
                    $('#expenseTotal').text('0');
                });
            }
            
            // Load data when page loads
            updateAllData();
            
            // Refresh data every 30 seconds
            setInterval(updateAllData, 30000);
        });
    </script>
</body>
</html>